---
title: "Final Project"
author: "Jackson Waschura, Bryan Liu, Camille Garlick, Eshley Freed-Doerr"
date: "5/27/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.align = 'center', message = FALSE, warning = FALSE)
```

```{r}
library(readxl)
library(tidyverse)
library(gridExtra)
```

# Understanding US School Expenditures and Test Scores

## Get the Data

```{r}
schools <- read_excel(here::here("data", "US_schools_data.xlsx"))
```

## Clean the Data


```{r}
# Select the relevant columns
schools <- schools %>% 
  select(PRIMARY_KEY, ends_with(c("EXPENDITURE", "READING", "MATHEMATICS")))
```

```{r}
# Split primary key
schools <- schools %>% 
  mutate(
    YEAR = as.integer(str_extract(PRIMARY_KEY, "^\\d{4}")),
    STATE = str_extract(PRIMARY_KEY, "(?<=\\d{4}_).*")
  ) %>%
  select(YEAR, STATE, TOTAL_EXPENDITURE:G08_TR_A_MATHEMATICS) 
```


```{r}
# Pivot longer
schools <- schools %>% 
  pivot_longer(
    cols = ends_with(c("MATHEMATICS", "READING")),
    names_to = c("GRADE", "RACE", "SEX", "TEST"),
    values_to = "SCORE",
    names_sep = "_"
  )
```


```{r}
# Seperate into regions
# Note: DODEA stands for "Department of Defense Education Activity," which are 
# DoD sponsored schools located in Virginia. Due to this, DODEA is put into 
# the same geographic region as Virginia.
# Additionally, National is grouped into its own region.

northeast <- c("MAINE", "NEW_HAMPHSIRE", "VERMONT", "MASSACHUSETTS", "RHODE_ISLAND", "CONNECTICUT", "NEW_YORK", "NEW_JERSEY", "PENNSYLVANIA")
midwest <- c("OHIO", "MICHIGAN", "INDIANA", "WISCONSIN", "ILLINOIS", "MINNESOTA", "IOWA", "MISSOURI", "NORTH_DAKOTA", "SOUTH_DAKOTA", "NEBRASKA", "KANSAS")
south <- c("DELAWARE", "MARYLAND", "VIRGINIA", "WEST_VIRGINIA", "KENTUCKY", "NORTH_CAROLINA", "SOUTH_CAROLINA", "TENNESSEE", "GEORGIA", "FLORIDA", "ALABAMA", "MISSISSIPPI", "ARKANSAS", "LOUISIANA", "TEXAS", "OKLAHOMA", "DISTRICT_OF_COLUMBIA")
west <- c("MONTANA", "IDAHO", "WYOMING", "COLORADO", "NEW_MEXICO", "ARIZONA", "UTAH", "NEVADA", "CALIFORNIA", "OREGON", "WASHINGTON", "ALASKA", "HAWAII")


schools <- schools %>%
  mutate(
    REGION = as.factor(case_when(
      STATE %in% northeast ~ "Northeast",
      STATE %in% midwest ~ "Midwest",
      STATE %in% south ~ "South",
      STATE %in% west ~ "West",
      STATE=="NATIONAL" ~ "NATIONAL"
    )),
    SEX = as.factor(SEX),
    RACE = as.factor(RACE)
  )
# Write more on later: grouping based off geography is significant as geography correlates with lots of significant factors, such as political views of population, major industries, etc.
```

```{r}
schools %>% distinct(RACE)
```

```{r}
# Additional cleaning here maybe lmao
schools <- schools %>%
  filter(!is.na(SCORE)) %>%
  filter(REGION != "NATIONAL") %>%
  mutate(RACE=fct_recode(RACE,
                         All="A",
                         White="WH",
                         Black="BL",
                         Hispanic="HI",
                         Asian="AS",
                         `American Indian`="AM",
                         `Pacific Islander`="HP",
                         `Two or more races`="TR"),
         SEX = fct_recode(SEX, All="A", Male="M", Female="F"),
         GRADE = fct_recode(GRADE, `8th Grade`="G08", `4th Grade`="G04"))
```


## Data Visualization

### Relationship between Instructional Expenditures and Testing Scores by Region

```{r, fig.height = 5}
# Excluding National: nothing significant about National here

schools %>%
  filter(REGION!="NATIONAL", !is.na(INSTRUCTION_EXPENDITURE) & !is.na(SCORE)) %>%
  ggplot(mapping=aes(color=REGION)) +
  geom_point(mapping=aes(y=SCORE, x=INSTRUCTION_EXPENDITURE), show.legend=FALSE) +
  facet_wrap(~ REGION, ncol = 2) +
  labs(title = "Instructional Expenditures and Testing Scores by Region")
```

### Distribution of Math and Reading Test Scores

```{r}
schools %>%
  filter(RACE=="All", SEX=="All") %>%
  ggplot(aes(x=SCORE, fill=TEST)) + 
  geom_histogram(alpha=0.6, position="identity", bins = 50) +
  facet_wrap(~GRADE) +
  labs(title = "Distribution of Math and Reading Test Scores")
```


### School Instructional Expenditures and Test Scores Over Time by Region


```{r, fig.width=10}
schools %>%
  filter(REGION!="NATIONAL", !is.na(INSTRUCTION_EXPENDITURE) & !is.na(SCORE)) %>%
  mutate(
    DECADE = floor(YEAR/10) * 10
  ) %>%
  ggplot(mapping=aes(color=REGION)) +
  geom_point(mapping=aes(y=SCORE, x=INSTRUCTION_EXPENDITURE), show.legend=FALSE) +
  facet_grid(REGION ~ DECADE) +
  labs(title = "School Instructional Expenditures and Test Scores Over Time by Region")
```


## Linear Regression

```{r}
# Model Reading
schools.lm = lm(SCORE~INSTRUCTION_EXPENDITURE,
                data=filter(.data=schools, TEST == "READING"))
broom::glance(schools.lm)$r.squared
```

```{r}
# Model Mathematics

schools.lm = lm(SCORE~INSTRUCTION_EXPENDITURE,
                data=filter(.data=schools, TEST == "MATHEMATICS"))
broom::glance(schools.lm)$r.squared
```

```{r}
# Modeling both tests

schools.lm = lm(SCORE~TEST+INSTRUCTION_EXPENDITURE, data=schools)
broom::glance(schools.lm)$r.squared
```

```{r}
# Modeling with additional variables

schools.lm = lm(SCORE~TEST+INSTRUCTION_EXPENDITURE+YEAR, data=schools)
broom::glance(schools.lm)$r.squared
```
### Selecting the "Best" Model
Describe the process we take (iteratively growing the model until adjusted R squared is maximized).

```{r}
# Modeling with additional variables

schools.lm = lm(SCORE~TEST+INSTRUCTION_EXPENDITURE+YEAR, data=schools)
broom::glance(schools.lm)$adj.r.squared
```
```{r}
# Modeling with additional variables

schools.lm = lm(SCORE~TEST+INSTRUCTION_EXPENDITURE+YEAR+GRADE, data=schools)
broom::glance(schools.lm)$adj.r.squared
```

```{r}
# Modeling with additional variables

schools.lm = lm(SCORE~TEST+INSTRUCTION_EXPENDITURE+YEAR+SEX, data=schools)
broom::glance(schools.lm)$adj.r.squared
```

```{r}
# Modeling with additional variables

schools.lm = lm(SCORE~TEST+INSTRUCTION_EXPENDITURE+YEAR+RACE, data=schools)
broom::glance(schools.lm)$adj.r.squared
```

```{r}
# Modeling with additional variables

schools.lm = lm(SCORE~TEST+INSTRUCTION_EXPENDITURE+YEAR+REGION, data=schools)
broom::glance(schools.lm)$adj.r.squared
```

So we should add grade and continue searching.

```{r}
# Modeling with additional variables

schools.lm = lm(SCORE~TEST+INSTRUCTION_EXPENDITURE+YEAR+GRADE+SEX, data=schools)
broom::glance(schools.lm)$adj.r.squared
```

```{r}
# Modeling with additional variables

schools.lm = lm(SCORE~TEST+INSTRUCTION_EXPENDITURE+YEAR+GRADE+RACE, data=schools)
broom::glance(schools.lm)$adj.r.squared
```

```{r}
# Modeling with additional variables

schools.lm = lm(SCORE~TEST+INSTRUCTION_EXPENDITURE+YEAR+GRADE+REGION, data=schools)
broom::glance(schools.lm)$adj.r.squared
```

So we should add race and continue searching.

```{r}
# Modeling with additional variables

schools.lm = lm(SCORE~TEST+INSTRUCTION_EXPENDITURE+YEAR+GRADE+RACE+SEX, data=schools)
broom::glance(schools.lm)$adj.r.squared
```

```{r}
# Modeling with additional variables

schools.lm = lm(SCORE~TEST+INSTRUCTION_EXPENDITURE+YEAR+GRADE+RACE+REGION, data=schools)
broom::glance(schools.lm)$adj.r.squared
```

So we should add region and continue searching.

```{r}
# Modeling with additional variables

schools.lm = lm(SCORE~TEST+INSTRUCTION_EXPENDITURE+YEAR+GRADE+RACE+REGION+SEX, data=schools)
broom::glance(schools.lm)$adj.r.squared
```

So we finally add sex as well and we have run out of individual predictors to add. The final model we chose included the test, instruction expenditure, year, grade, race, region, and sex as predictors. It achieved the maximal adjusted R squared at 0.9215.

```{r, fig.width=12}
schools %>% filter(SEX != "A") %>% ggplot(mapping=aes(x=INSTRUCTION_EXPENDITURE, y=SCORE, color=GRADE)) +
  facet_grid(TEST~REGION) +
  geom_point() +
  geom_smooth(method = "lm", mapping=aes()) +
  labs(title = "Test Score and Expenditure Relationships By Grade and Region") +
  theme(panel.spacing.x = unit(6, "mm"), panel.spacing.y = unit(6, "mm"))
```

```{r, fig.width=12}
schools %>% filter(RACE != "All") %>% ggplot(mapping=aes(x=INSTRUCTION_EXPENDITURE, y=SCORE, color=GRADE)) +
  facet_grid(TEST~RACE) +
  geom_point() +
  geom_smooth(method = "lm", mapping=aes()) + 
  scale_x_continuous(n.breaks = 3) +
  labs(title = "Test Score and Expenditure Relationships By Grade and Region") +
  theme(panel.spacing.x = unit(6, "mm"), panel.spacing.y = unit(6, "mm"))
```

```{r, fig.width=12}
schools %>% filter(SEX != "All") %>% ggplot(mapping=aes(x=INSTRUCTION_EXPENDITURE, y=SCORE, color=GRADE)) +
  facet_grid(TEST~SEX) +
  geom_point() +
  geom_smooth(method = "lm", mapping=aes()) + 
  scale_x_continuous(n.breaks = 3) +
  labs(title = "Test Score and Expenditure Relationships By Grade and Sex") +
  theme(panel.spacing.x = unit(6, "mm"), panel.spacing.y = unit(6, "mm"))
```

### Simulation and Predictive Checks

```{r}
schools <- schools %>% mutate(
  SIM_SCORE = predict(schools.lm, newdata = schools)
               + rnorm(length(schools), sd=sqrt(sigma(schools.lm)))
)
```

```{r, fig.width=12}
schools %>% filter(SEX != "A") %>% ggplot(mapping=aes(x=INSTRUCTION_EXPENDITURE, y=SIM_SCORE, color=GRADE)) +
  facet_grid(TEST~REGION) +
  geom_point() +
  geom_smooth(method = "lm", mapping=aes()) +
  labs(title = "Test Score and Expenditure Relationships By Grade and Region") +
  theme(panel.spacing.x = unit(6, "mm"), panel.spacing.y = unit(6, "mm"))
```

```{r, fig.width=12}
schools %>% filter(RACE != "All") %>% ggplot(mapping=aes(x=INSTRUCTION_EXPENDITURE, y=SIM_SCORE, color=GRADE)) +
  facet_grid(TEST~RACE) +
  geom_point() +
  geom_smooth(method = "lm", mapping=aes()) + 
  scale_x_continuous(n.breaks = 3) +
  labs(title = "Test Score and Expenditure Relationships By Grade and Region") +
  theme(panel.spacing.x = unit(6, "mm"), panel.spacing.y = unit(6, "mm"))
```

```{r, fig.width=12}
schools %>% filter(SEX != "All") %>% ggplot(mapping=aes(x=INSTRUCTION_EXPENDITURE, y=SIM_SCORE, color=GRADE)) +
  facet_grid(TEST~SEX) +
  geom_point() +
  geom_smooth(method = "lm", mapping=aes()) + 
  scale_x_continuous(n.breaks = 3) +
  labs(title = "Test Score and Expenditure Relationships By Grade and Sex") +
  theme(panel.spacing.x = unit(6, "mm"), panel.spacing.y = unit(6, "mm"))
```

```{r}
# TODO: ESHLEY Add units to Instruction Expenditure (INSTRUCTION_EXPENDITURE)
# TODO: ESHLEY Make gridArrange work with a shared legend (https://www.rdocumentation.org/packages/lemon/versions/0.4.5/topics/grid_arrange_shared_legend)
 
obs_plot <- schools %>% ggplot(mapping=aes(x=INSTRUCTION_EXPENDITURE, y=SCORE, color=GRADE)) +
  geom_point() +
  geom_smooth(method = "lm") +
  scale_y_continuous(limits=c(180, 320)) +
  labs(title = "Observed Scores", y = "Observed Scores") +
  theme(legend.position = "None")

sim_plot <- schools %>% ggplot(mapping=aes(x=INSTRUCTION_EXPENDITURE, y=SIM_SCORE, color=GRADE)) +
  geom_point() +
  geom_smooth(method = "lm") +
  scale_y_continuous(limits=c(180, 320)) +
  labs(title = "Simulated Scores") +
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank())

grid.arrange(obs_plot, sim_plot, ncol=2)
```

```{r}
get_sim_r_sq <- function(n){
  simulated <- predict(schools.lm, newdata = schools) +
    rnorm(length(schools), sd=sqrt(sigma(schools.lm)))
  return(broom::glance(lm(schools$SCORE ~ simulated))$r.squared)
}

n_sims <- 1000
simulation_results <- tibble(`R Squared`=as_vector(map(1:n_sims, get_sim_r_sq)))
```

```{r}
mean_r_sq <- mean(simulation_results$`R Squared`)

simulation_results %>%
  ggplot(mapping = aes(x=`R Squared`)) +
  geom_histogram(bins=50) +
  geom_vline(xintercept=mean_r_sq, color="Orange") +
  annotate("text", x=mean_r_sq+0.0015, y=n_sims*0.025,
           label=format(mean_r_sq, digits=3), color="Orange", size=5) +
  labs(title = "Distribution of Percent of Observed Variation explained by Model")
```
